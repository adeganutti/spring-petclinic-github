//noinspection GroovyUnusedAssignment
@Library("jenkins-libraries@main") _

def env
def run

node {
    try {
        stage('Checkout') {
            checkout scm
        }

        stage('Setup') {
            def cfg = yamlFile(params.CONFIGURATION_FILE)
            env = cfg.env
            run = cfg.run
        }

        stage('Maven Build') {
            sh "mvn clean install"
        }

        stage('Maven Test') {
            sh 'mvn test'
        }

        stage('Analysis') {
            def analysisStagesMap = [:]
            analysisStagesMap.put("JaCoCo Analysis", jaCoCoAnalysis())
            analysisStagesMap.put("SonarQube Analysis", sonarQubeAnalysis(env.sonarqube.env.name, env.sonarqube.credential.id))
            analysisStagesMap.put("Nexus IQ Analysis", nexusIqAnalysis(env.nexus.application.name))
            parallelOrSerialStages.call(runParallel, analysisStagesMap)
        }

        stage('Maven Package') {
            sh "mvn package -DskipTests=true"
        }

        stage('Artifact Repository Push') {
            def artifactRepositoryStagesMap = [:]
            artifactRepositoryStagesMap.put("Artifactory Repository Push", artifactoryRepositoryPush(env.artifactory.server.id, env.artifactory.server.url, env.artifactory.repository.url, env.artifactory.build.name, env.artifactory.project.name, env.artifactory.credential.id))
            artifactRepositoryStagesMap.put("Nexus Repository Push", nexusRepositoryPush(env.nexus.server.url, env.nexus.repository.name, env.nexus.version.name, env.nexus.protocol.name, env.nexus.credential.id))
            parallelOrSerialStages.call(runParallel, artifactRepositoryStagesMap)
        }

        stage("Deploy") {
            okteto.call(env.okteto.server.url, env.okteto.repository.name, env.okteto.repository.url, env.okteto.deployment.name, env.okteto.credential.id)
        }
    } catch (e) {
        throw e
    } finally {
        junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
    }
}

def jaCoCoAnalysis() {
    return {
        stage('JaCoCo Analysis') {
            jacoco(execPattern: 'target/jacoco.exec')
        }
    } as Object
}

def sonarQubeAnalysis(sonarqubeEnv, sonarqubeCredentialId) {
    return {
        stage('SonarQube Analysis') {
            sonarqube.call(sonarqubeEnv, sonarqubeCredentialId)
        }
    } as Object
}

def nexusIqAnalysis(nexusApplication) {
    return {
        stage('Nexus IQ Analysis') {
            nexusPolicyEvaluation advancedProperties: '', enableDebugLogging: false, failBuildOnNetworkError: false, iqApplication: selectedApplication(nexusApplication), iqStage: 'build', jobCredentialsId: ''
        }
    } as Object
}

def artifactoryRepositoryPush(artifactoryServerId, artifactoryServerUrl, artifactoryRepositoryUrl, artifactoryBuildName, artifactoryProject, artifactoryCredentialId) {
    return {
        stage('Artifactory Repository Push') {
            artifactory.call(artifactoryServerId, artifactoryServerUrl, artifactoryRepositoryUrl, artifactoryBuildName, artifactoryProject, artifactoryCredentialId)
        }
    } as Object
}

def nexusRepositoryPush(nexusServerUrl, nexusRepositoryName, nexusVersion, nexusProtocol, nexusCredentialId) {
    return {
        stage('Nexus Repository Push') {
            nexusRepository.call(nexusServerUrl, nexusRepositoryName, nexusVersion, nexusProtocol, nexusCredentialId)
        }
    } as Object
}
